!function(){"use strict";function t(t,e){var o=new XMLHttpRequest;o.open("GET",t,!1),o.onreadystatechange=function(){4===this.readyState&&200===this.status&&(document.getElementById(e).innerHTML=this.responseText)},o.send()}function e(t,e,o,n){var i="";if(o){var a=new Date;a.setTime(a.getTime()+24*o*60*60*1e3),i="; expires="+a.toUTCString()}var c="";n&&(c="; secure; HttpOnly"),document.cookie=t+"="+(e||"")+i+"; path=/"+c}function o(t){for(var e=t+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(var i=o[n];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(e))return i.substring(e.length,i.length)}return null}function n(){document.getElementById("spinnerBox").style.display="none"}function i(){return new Promise((function(t,e){grecaptcha.ready((function(){grecaptcha.execute("6LdfLOEUAAAAAAGmzOyh5Kk08M98p5sWceMN9HVc",{action:"homepage"}).then((function(e){t(e)}))}))}))}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function s(t,e,o){return e&&c(t.prototype,e),o&&c(t,o),t}function r(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var l=function(){function t(e){a(this,t),this.init(),window.afterFBInit=e}return s(t,[{key:"init",value:function(){var t,e,o,n,i;window.loginfun=function(){var t=encodeURI(location.protocol+"//"+location.host+"/");window.location=encodeURI("https://www.facebook.com/dialog/oauth?client_id=273875460184611&redirect_uri="+t+"&response_type=token")},window.storeHttpOnlyCookie=function(t){return window.facebookService.storeHttpOnlyCookie(t)},window.fbAsyncInit=function(){FB.init({appId:"273875460184611",cookie:!0,status:!0,xfbml:!0,version:"v3.3"}),FB.AppEvents.logPageView(),FB.Event.subscribe("auth.authResponseChange",(function(t){})),window.facebookService.onLogin()},t=document,e="script",o="facebook-jssdk",i=t.getElementsByTagName(e)[0],t.getElementById(o)||((n=t.createElement(e)).id=o,n.src="https://connect.facebook.net/lv_LV/sdk.js",i.parentNode.insertBefore(n,i))}},{key:"onLogin",value:function(){this.checkFBLoginStatus().then((function(t){return window.facebookService.storeHttpOnlyCookie(t)})).then((function(t){return window.voteService.fetchMyVotes(),t})).then((function(t){return window.loginCallback&&(window.loginCallback(t),window.loginCallback=null),t}),(function(){throw"FB not logged in"})).catch((function(t){console.log(t)}))}},{key:"loginIfNeeded",value:function(){return new Promise((function(t,e){$("#loginModal").modal("hide");window.facebookService.checkFBLoginStatus().then((function(){window.facebookService.onLogin(),t()}),(function(){window.loginCallback=function(e){$("#loginModal").modal("hide"),t(e)},$("#loginModal").modal("show")}))}))}},{key:"checkFBLoginStatus",value:function(){return new Promise((function(t,e){FB.getLoginStatus((function(o){if("connected"==o.status){var n=o.authResponse.accessToken;t(n)}else e(o)}))}))}},{key:"storeHttpOnlyCookie",value:function(t){return new Promise((function(e,o){$.ajax({url:"/app/login",type:"POST",processData:!1,crossDomain:!0,headers:{token:t},data:"",success:function(){e(t)},error:function(t,e,o){console.log("Error in storeHttpOnlyCookie: "+o)}})}))}}]),t}(),d=function(){function t(){a(this,t),this.data={},window.doVote=function(t){return window.voteService.doVote(t)}}return s(t,[{key:"fetchMyVotes",value:function(){fetch("/app/myvotes",{method:"GET",cache:"no-cache"}).then((function(t){return t.json()})).then((function(t){window.myvotes=t})).catch((function(t){console.log("ploblem fetching votes "+t)}))}},{key:"doVote",value:function(t){window.placeID=t,window.facebookService.loginIfNeeded().then((function(){var t=document.getElementById("btnLike"),e=!0;t.classList.contains("btn-success")&&(e=!1),e?(t.classList.remove("btn-outline-success"),t.classList.add("btn-success")):(t.classList.add("btn-outline-success"),t.classList.remove("btn-success")),window.voteService.vote(window.placeID,e,(function(t){var o=document.getElementById("voteCount"),n=t.votes;n<1&&(n=""),o.innerHTML=n,window.myvotes[window.placeID]=e,window.votes[window.placeID]=t.votes}),(function(t,e,o){alert("Error while saving vote: "+o)}))}))}},{key:"vote",value:function(t,e,o,n){i().then((function(i){$.ajax({url:"/app/vote",type:"POST",processData:!1,crossDomain:!0,headers:{"x-captcha":i},data:"place="+t+"&isUpvote="+e,success:function(t){o(t)},error:n})}))}},{key:"toggleVoteButton",value:function(){btnLike.classList.toggle("btn-outline-success"),btnLike.classList.toggle("btn-success")}}]),t}(),u=function(){function t(){a(this,t),$("#uploadimage").change((function(){window.setImg(this)}));var e=this;$(document).on("click","#choose-location-btn",(function(){e.showCrosshair(),e.setCurrentLocation()})),$(document).on("click","#select-location-btn",(function(){e.getCrosshairLocation(),$("#report").modal("show"),e.retrieveEmailFromCookie(),e.hideCrosshair()})),$(document).on("click","#cancel-btn",(function(){e.hideCrosshair()})),$("#myform").on("submit",(function(t){e.submitForm(t)}))}return s(t,[{key:"submitForm",value:function(t){document.getElementById("spinnerBox").style.display="block",this.storeEmailInCookie();var e=new FormData($("#myform")[0]);t.preventDefault(),i().then((function(t){var o;$.ajax((r(o={url:"/app/upload",type:"POST",contentType:"multipart/form-data",processData:!1},"contentType",!1),r(o,"crossDomain",!0),r(o,"headers",{"x-captcha":t}),r(o,"data",e),r(o,"success",(function(t){n(),alert("Paldies par veloslazdu! Veloslazdi, kas iekļūs vietnes “Topā” tiks nosūtīti RDSD.\n                        Balso par veloslazdiem, izvēloties tos kartē un autorizējoties ar Facebook."),location.reload()})),r(o,"error",(function(t,e,o){n(),alert("Pārliecinies, vai esi pievienojis veloslazdam kategoriju un nosaukumu! Ja neizdodas pievienot punktu, raksti uz info@datuskola.lv")})),o))}))}},{key:"showCrosshair",value:function(){document.getElementById("color-codes").classList.add("d-none"),document.getElementById("color-codes-strip").classList.add("d-none"),document.getElementById("report-btn").classList.add("d-none"),document.getElementById("report-btn-2").classList.add("d-none"),document.getElementById("crosshair").classList.remove("hidden"),document.getElementById("select-location-btn").classList.remove("d-none"),document.getElementById("cancel-btn").classList.remove("d-none"),this.centerCrosshair()}},{key:"centerCrosshair",value:function(){var t=document.getElementById("main"),e=document.getElementById("box1"),o=document.getElementById("top-row"),n=t.offsetTop,i=t.offsetLeft,a=e.offsetTop-o.offsetHeight,c=i+t.offsetWidth/2-20,s=n+a/2-20,r=document.getElementById("crosshair");r.style.left=c+"px",r.style.top=s+"px"}},{key:"getCrosshairLocation",value:function(){var t=$("#top-row").height(),e=document.getElementById("crosshair"),o=L.point(e.offsetLeft+20,e.offsetTop-t),n=window.mymap.containerPointToLatLng(o);document.getElementById("lat").value=n.lat,document.getElementById("lon").value=n.lng}},{key:"hideCrosshair",value:function(){document.getElementById("color-codes").classList.remove("d-none"),document.getElementById("color-codes-strip").classList.remove("d-none"),document.getElementById("report-btn").classList.remove("d-none"),document.getElementById("report-btn-2").classList.remove("d-none"),document.getElementById("crosshair").classList.add("hidden"),document.getElementById("select-location-btn").classList.add("d-none"),document.getElementById("cancel-btn").classList.add("d-none")}},{key:"setCurrentLocation",value:function(){navigator.geolocation.getCurrentPosition((function(t){var e=t.coords.latitude,o=t.coords.longitude;window.mymap.setView([e,o],window.mymap.getZoom())}))}},{key:"retrieveEmailFromCookie",value:function(){var t=document.getElementById("email"),e=o("email");e&&e.length>0&&(t.value=e)}},{key:"storeEmailInCookie",value:function(){e("email",document.getElementById("email").value,3,!1)}}]),t}();function m(t){if(t.files&&t.files[0]){if(t.files[0].size/1024/1024>10)return document.getElementById("uploadimage").value=null,void alert("Maksimālais faila izmērs 10MB");var e=new FileReader;e.onload=function(t){$("#img-upload").attr("src",t.target.result)},e.readAsDataURL(t.files[0])}}function p(){$("#vote-top").modal("show"),fetch("/app/top",{method:"GET",cache:"no-cache"}).then((function(t){return t.json()})).then((function(t){for(var e=["Šaurība / nepārredzamība","Strauji pagriezieni","Segums (bedres, bīstamas apmales)","Cits"],o=document.getElementById("top-content"),n="",i=0;i<4;i++)if(t&&t[i]){for(var a="",c=0;c<3;c++){var s=t[i][c];if(s){for(var r=window.places,l=s[0],d=s[1],u=null,m=0;m<r.length;m++)r[m].id==l&&(u=r[m]);if(u){var p="/images/noimage.png",g="";u.img&&u.img.length>0&&(p="/app/files/2"+u.img,g="/app/files/"+u.img),a+='<div class="top-item">\n\t\t\t\t\t\t<div class="top-image-box">\n\t\t\t\t\t\t\t<img class="top-image" src=\''.concat(p,"' full-src='").concat(g,'\' />\n\t\t\t\t\t\t</div>\t\t\n\t\t\t\t\t\t<img id="top-zoom-in" src="/images/zoom-in.png" >\n\t\t\t\t\t\t<div class="top-vote-count">👍&nbsp;').concat(d,'</div>\t\t\n\t\t\t\t\t\t<div class="top-number">').concat(c+1,'</div>\n\t\t\t\t\t\t<div class="top-text">').concat(u.description,"</div>\n\t\t\t\t\t</div>")}}}a.length>0&&(n+='<div class="vote-top-title color-'.concat(i,'">').concat(i+1,"- ").concat(e[i],'\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="vote-top-row" id="type').concat(i,'">\n\t\t\t\t\t\t\t').concat(a,"\n\t\t\t\t\t\t</div>"))}n+='<div class="top-footer">Tops uzrāda punktus, par kuriem RD Satiksmes departaments vēl nav sniedzis atbildi. Pilns tops pieejams “Visi dati” sadaļā.</div>',o.innerHTML=n})).catch((function(t){return console.log("e1"+t)}))}$(window).on("load",(function(){t("public/start.e059a7557042acf58528a0c88531419d.html","start"),t("public/choose-place.4c0fc8f06ca674f8743a65473f9c9f6f.html","choose-place"),t("public/report.33c442742f0347f172b5f57713445614.html","report"),t("public/vote-top.2f94a4b3ba649f6c2e9a74082872d960.html","vote-top"),t("public/about-us.717d35ad7ab2787abe7e8eeff5145f0a.html","about-us"),t("public/big-image.9f85b967b17eaa16a26aec475a730bd4.html","big-image-box"),t("public/finish-message.d9399de7b464c6e84b070742e1235e37.html","finish-message"),o("finishVisited")||($("#finish-message").modal("show"),e("finishVisited",!0,365));var n=location.toString().split("?")[1];n&&(window.isRedirectFromFB=n.substring(1).split("&").map((function(t){return t.split("=")})).filter((function(t){return"data_access_expiration_time"==t[0]})).reduce((function(t){return t+1}),0)),window.mymap=L.map("mapid",{zoomControl:!1,closePopupOnClick:!1}).setView([56.951259,24.112614],13),L.control.zoom({position:"bottomleft"}).addTo(window.mymap),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(window.mymap),window.group=L.markerClusterGroup({chunkedLoading:!0,spiderfyOnMaxZoom:!0}),fetch("/app/places").then((function(t){return t.json()})).then((function(t){window.votes=t.votes,window.places=t.places;var n=t.places,i=[91,99],a=[45,75],c=[-3,-76],s=[L.icon({iconUrl:"images/location.png",iconSize:i,iconAnchor:a,popupAnchor:c}),L.icon({iconUrl:"images/location2.png",iconSize:i,iconAnchor:a,popupAnchor:c}),L.icon({iconUrl:"images/location3.png",iconSize:i,iconAnchor:a,popupAnchor:c}),L.icon({iconUrl:"images/location4.png",iconSize:i,iconAnchor:a,popupAnchor:c})],r=o("placeId");e("placeId",null,1,!1);for(var l=0;l<n.length;l++){var d=n[l].id,u=L.marker([n[l].lat,n[l].lon],{icon:s[n[l].placeType],place:n[l]});u.bindPopup((function(t){var o=t.options.place,n=window.votes[o.id];n||(n="");var i,a=null;window.myvotes&&(a=window.myvotes[o.id]),i=a?"btn-success":"btn-outline-success";var c="/images/noimage.png",s="popup-noimage";return o.img&&o.img.length>0&&(c="/app/files/"+o.img,s="popup-image"),e("placeId",o.id,1,!1),"<div id='popup' class='mycontainer'>\n\t\t\t\t\t\t\t\t<div class='gridbox-left'>\n\t\t\t\t\t\t\t\t\t<img id='small-image' src='".concat(c,"' class='").concat(s,"'/> \n\t\t\t\t\t\t\t\t\t<img id='small-zoom-in' src=\"/images/zoom-in.png\" >\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t<div class='gridbox-left'>\n\t\t\t\t\t\t\t\t\t").concat(o.description,"</div>\n\n\t\t\t\t\t\t\t\t<div class='gridbox-right'>\n\t\t\t\t\t\t\t\t\tBalsot\n\t\t\t\t\t\t\t\t\t<button type='button' id='btnLike' class='btn ").concat(i,"'\n\t\t\t\t\t\t\t\t\t\tonclick='doVote(").concat(o.id,')\'>👍 <div id="voteCount">').concat(n,"</div></button>\n \t\t</div>")})),window.group.addLayer(u),window.isRedirectFromFB&&d&&d==r&&(window.markerPoupup=u,window.lat=n[l].lat,window.lon=n[l].lon)}window.mymap.addLayer(window.group),window.markerPoupup&&(window.markerPoupup.openPopup(),window.mymap.setView([window.lat,window.lon],13),history.replaceState(null,null,"/"),window.loginCallback=function(){window.voteService.doVote(r)},window.facebookService.onLogin())})).catch((function(t){console.log("e2 "+t)})),window.setImg=m,window.showVoteTop=p,window.voteService=new d,window.facebookService=new l,window.showBigImage=function(t){0!=t.length&&"/images/noimage.png"!=t&&(document.getElementById("big-image-src").setAttribute("src",t),$("#big-image-box").modal("show"))};new u;$(document).on("click","#small-image",(function(){var t=document.getElementById("small-image").getAttribute("src");window.showBigImage(t)})),$(document).on("click","#small-zoom-in",(function(){var t=document.getElementById("small-image").getAttribute("src");window.showBigImage(t)})),$(document).on("click",".top-image",(function(t){var e=t.target.getAttribute("full-src");window.showBigImage(e)})),$(document).on("click","#top-zoom-in",(function(t){var e=t.target.parentNode.getElementsByClassName("top-image")[0].getAttribute("full-src");window.showBigImage(e)}))}))}();
